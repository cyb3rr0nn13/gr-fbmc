#!/usr/bin/env python
# -*- coding: utf-8 -*-
# 
# Copyright 2014 Communications Engineering Lab (CEL), Karlsruhe Institute of Technology (KIT).
# 
# This is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 3, or (at your option)
# any later version.
# 
# This software is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with this software; see the file COPYING.  If not, write to
# the Free Software Foundation, Inc., 51 Franklin Street,
# Boston, MA 02110-1301, USA.
# 

from gnuradio import gr, gr_unittest
from gnuradio import blocks, fft
import fbmc_swig as fbmc
import pylab as pl

class qa_rx (gr_unittest.TestCase):

	def setUp (self):
		self.tb = gr.top_block ()

	def tearDown (self):
		self.tb = None

	def test_001_t (self):
		L = 8
		print "test 1 - L =", L
		num_items = L; # does not refer to symbols but to the number of items the head block lets through
		overlap = 4 # this is hardcoded and not changeable at the moment
		iq_data = ((-0.00044857551619-0.00044857551619j) ,
				(0.000229785631692+9.51803250852e-05j) ,
				(0.000235008650809+0j) ,
				(-0.000786418595356+0.000325745247899j) ,
				(0.0029583569193-0.0029583569193j) ,
				(0.00458181268753-0.0110614743305j) ,
				0j ,
				(0.0101093232545+0.0244060653074j) ,
				(0.0134400202724+0.01254286924j) ,
				(0.00975847802034+0.00423245459431j) ,
				(-0.0215717198951+0j) ,
				(0.00448376796271-0.00120574700489j) ,
				(-0.137716406886+0.132248268564j) ,
				(-0.215114799807+0.499294519548j) ,
				-0.000117504325405j ,
				(-0.488114734649-1.13673473818j) ,
				(-0.676335831811-0.651965572669j) ,
				(-0.25964502846-0.121691428548j) ,
				(-0.999416226968+0.0107757996582j) ,
				(1.81418119521-0.802989724788j) ,
				(-0.151156427158+0.417901879642j) ,
				(0.515256420303-0.261694046575j) ,
				(-0.0107757996582+0.0107858599476j) ,
				(0.456298458913-0.898936890206j) ,
				(-0.121766605211-1.36154673438j) ,
				(0.583015566091+1.07714755376j) ,
				(0.0107657393689-0.47821526633j) ,
				(0.0756685134429+0.743323552321j) ,
				(0.668363949861+0.121318029694j) ,
				(0.651072260902+0.347989657838j) ,
				(0.499766865647+0.499766865647j) ,
				(-1.56545373081-0.117589633267j) ,
				(-0.27973689724+0.84684899308j) ,
				(0.0319435766181+0.682387824446j) ,
				(-0.499766865647-0.988767991924j) ,
				(-0.650533312684-1.5559741121j) ,
				(0.67929418873+0.548652512762j) ,
				(-0.452941798149-0.462707273885j) ,
				(0.0107858599476-0.0107757996582j) ,
				(0.480818026103+0.518103217719j) ,
				(0.0029583569193-0.0143371713047j) ,
				(-1.00977937991-0.55398060774j) ,
				(0.0107757996582-1.02098794686j) ,
				(-1.79142396516+0.770310989561j) ,
				(-0.692285633486-0.689775852083j) ,
				(0.222089662503-0.504623533939j) ,
				(-0.000117504325405+0j) ,
				(-0.0937032563404-0.212396961827j) ,
				(0.141123339322-0.140674763805j) ,
				(0.125196261535+0.0540823171728j) ,
				-0.0213367112443j ,
				(0.0288361498603-0.0125942562723j) ,
				(0.0138885957885+0.0138885957885j) ,
				(-0.00445727499753+0.0107608137503j) ,
				0j ,
				(0.00197669891847+0.0047721733377j) ,
				(-0.0029583569193+0.0029583569193j) ,
				(-0.00189858243861-0.000786418595356j) ,
				0.000235008650809j ,
				(-0.000554751588469+0.000229785631692j) ,
				(-0.00044857551619-0.00044857551619j) ,
				0j ,
				0j ,
				0j )
		ref_symbols = [-0.70710677-0.70710677j, -0.70710677+0.70710677j, -0.70710677-0.70710677j, \
				   0.70710677+0.70710677j, -0.70710677+0.70710677j,  0.70710677-0.70710677j, \
				   0.70710677+0.70710677j,  0.70710677-0.70710677j, -0.70710677-0.70710677j, \
				   0.70710677-0.70710677j,  0.70710677-0.70710677j, -0.70710677-0.70710677j, \
				   0.70710677+0.70710677j,  0.70710677-0.70710677j, -0.70710677+0.70710677j, \
				  -0.70710677+0.70710677j, -0.70710677-0.70710677j,  0.70710677+0.70710677j, \
				  -0.70710677-0.70710677j,  0.70710677-0.70710677j,  0.70710677+0.70710677j, \
				   0.70710677+0.70710677j,  0.70710677-0.70710677j, -0.70710677+0.70710677j, \
				   0.70710677+0.70710677j, -0.70710677+0.70710677j, -0.70710677-0.70710677j,\
				   0.70710677-0.70710677j, -0.70710677+0.70710677j,  0.70710677-0.70710677j,\
				   0.70710677+0.70710677j, -0.70710677-0.70710677j]
				   
		ref_input_comm = pl.asarray(
				[[
				(-0.00044857551619-0.00044857551619j) ,
				(0.0029583569193-0.0029583569193j) ,
				(0.0134400202724+0.01254286924j) ,
				(-0.137716406886+0.132248268564j) ,
				(-0.676335831811-0.651965572669j) ,
				(-0.151156427158+0.417901879642j) ,
				(-0.121766605211-1.36154673438j) ,
				(0.668363949861+0.121318029694j) ,
				(-0.27973689724+0.84684899308j) ,
				(0.67929418873+0.548652512762j) ,
				(0.0029583569193-0.0143371713047j) ,
				(-0.692285633486-0.689775852083j) ,
				(0.141123339322-0.140674763805j) ,
				(0.0138885957885+0.0138885957885j) ,
				(-0.0029583569193+0.0029583569193j) ,
				(-0.00044857551619-0.00044857551619j)
				],
				[
				0j ,
				(-0.000786418595356+0.000325745247899j) ,
				(0.0101093232545+0.0244060653074j) ,
				(0.00448376796271-0.00120574700489j) ,
				(-0.488114734649-1.13673473818j) ,
				(1.81418119521-0.802989724788j) ,
				(0.456298458913-0.898936890206j) ,
				(0.0756685134429+0.743323552321j) ,
				(-1.56545373081-0.117589633267j) ,
				(-0.650533312684-1.5559741121j) ,
				(0.480818026103+0.518103217719j) ,
				(-1.79142396516+0.770310989561j) ,
				(-0.0937032563404-0.212396961827j) ,
				(0.0288361498603-0.0125942562723j) ,
				(0.00197669891847+0.0047721733377j) ,
				(-0.000554751588469+0.000229785631692j)
				],
				[
				0j ,
				(0.000235008650809+0j) ,
				0j ,
				(-0.0215717198951+0j) ,
				-0.000117504325405j ,
				(-0.999416226968+0.0107757996582j) ,
				(-0.0107757996582+0.0107858599476j) ,
				(0.0107657393689-0.47821526633j) ,
				(0.499766865647+0.499766865647j) ,
				(-0.499766865647-0.988767991924j) ,
				(0.0107858599476-0.0107757996582j) ,
				(0.0107757996582-1.02098794686j) ,
				(-0.000117504325405+0j) ,
				-0.0213367112443j ,
				0j ,
				0.000235008650809j
				],
				[
				0j ,
				(0.000229785631692+9.51803250852e-05j) ,
				(0.00458181268753-0.0110614743305j) ,
				(0.00975847802034+0.00423245459431j) ,
				(-0.215114799807+0.499294519548j) ,
				(-0.25964502846-0.121691428548j) ,
				(0.515256420303-0.261694046575j) ,
				(0.583015566091+1.07714755376j) ,
				(0.651072260902+0.347989657838j) ,
				(0.0319435766181+0.682387824446j) ,
				(-0.452941798149-0.462707273885j) ,
				(-1.00977937991-0.55398060774j) ,
				(0.222089662503-0.504623533939j) ,
				(0.125196261535+0.0540823171728j) ,
				(-0.00445727499753+0.0107608137503j) ,
				(-0.00189858243861-0.000786418595356j)
				]]).flatten(order='F')
				
		ref_ppfb = pl.asarray(
				[[
				(-1.42284024508e-07-1.42284024508e-07j) ,
				(9.38363582536e-07-9.38363582536e-07j) ,
				(8.52610142466e-06+8.24153337564e-06j) ,
				(-7.17972092152e-05+7.00627660747e-05j) ,
				(-0.000557720994645-0.000541464871353j) ,
				(0.0026818445653-0.00254526874862j) ,
				(0.0128489098808+0.011793127829j) ,
				(-0.0645294049698+0.0596183312987j) ,
				(-0.323926168616-0.300072159906j) ,
				(-0.0774321214932+0.19849560167j) ,
				(-0.0493973170564-0.65584920616j) ,
				(0.315755177156+0.048910597191j) ,
				(-0.133407679626+0.41959430613j) ,
				(0.326471579649+0.269075516938j) ,
				(0.00269875448412-0.0140287036255j) ,
				(-0.338903832431-0.336630261147j) 
				],
				[
				0j ,
				(-1.80707696801e-07+7.48515788401e-08j) ,
				(2.32297726977e-06+5.60816322975e-06j) ,
				(5.55237265844e-06-2.15016490079e-06j) ,
				(-0.000170292423446-0.000401545163566j) ,
				(3.4219140525e-05-2.97613806474e-05j) ,
				(0.00749914765412+0.0174051891686j) ,
				(-0.00837223476272+0.00423785737923j) ,
				(-0.224583998215-0.51093542141j) ,
				(0.822634423263-0.369011086038j) ,
				(0.220886744964-0.396167873008j) ,
				(0.0201624791+0.354186782327j) ,
				(-0.717580554912-0.0477158007149j) ,
				(-0.285629722574-0.717694183185j) ,
				(0.233835517819+0.237468488876j) ,
				(-0.806824385008+0.364647066324j) 
				],
				[
				0j ,
				(-1.95264238619e-08+0j) ,
				0j ,
				(3.58470673017e-06+0j) ,
				9.76321193099e-09j ,
				(1.56674836334e-06-8.95340792148e-07j) ,
				(8.95340792148e-07-1.79235336509e-06j) ,
				(-0.0152481864563+0.000121918383293j) ,
				(-0.000123709064877-7.88255787453e-07j) ,
				(-0.352894245954+0.000242968433827j) ,
				(2.65901434772e-06+0.00762498940486j) ,
				(0.00760718727759-0.176534164367j) ,
				(0.176776264469+0.176447517105j) ,
				(-0.176611732558-0.35356050598j) ,
				(2.65901435208e-06-0.00761608834121j) ,
				(0.00761608834121-0.3534341379j) 
				],
				[
				0j ,
				(-1.80707696801e-07-7.48515788401e-08j) ,
				(-3.60322275958e-06+8.69894925444e-06j) ,
				(1.18134114395e-06+3.39624365932e-07j) ,
				(0.000345746395801-0.000818946951148j) ,
				(0.000627605195506+0.000278421062969j) ,
				(-0.00775149770681+0.0171690599095j) ,
				(-0.00845547969431-0.00466537946521j) ,
				(-0.0249913909671+0.0925508292989j) ,
				(-0.031089938955+0.0158862906463j) ,
				(0.132553134663-0.0423576688604j) ,
				(0.123287984304+0.249180213667j) ,
				(0.114206811346+0.0554186138314j) ,
				(-0.0350258584372+0.114397584053j) ,
				(-0.0876443327439-0.11632665794j) ,
				(-0.203342223393-0.115076428102j) 
				],
				[
				0j ,
				(9.38363582538e-07+9.38363582538e-07j) ,
				(-6.1885107346e-06+6.1885107346e-06j) ,
				(-7.19394932399e-05-7.00627660748e-05j) ,
				(0.000577109181096-0.00056567052321j) ,
				(0.00268403987197+0.00254541103264j) ,
				(-0.0128493105529+0.0117570897189j) ,
				(-0.0645075369087-0.0596208111732j) ,
				(-0.0296264460018+0.0535006442425j) ,
				(-0.0774154715698-0.198512652266j) ,
				(0.0493969163842+0.0512560230758j) ,
				(-0.0378172263205-0.0488908083327j) ,
				(0.133427067813+0.0660231046698j) ,
				(-0.0270810349692+0.0844766970081j) ,
				(-0.00269641689342-0.0140702182611j) ,
				(0.0146677697017-0.0169219527989j) 
				],
				[
				0j ,
				0j ,
				(3.49736664162e-06-1.44865669555e-06j) ,
				(-4.4958257763e-05-0.000108538835632j) ,
				(-0.000181951805926+7.24695923218e-05j) ,
				(0.00425338800103+0.0100832341768j) ,
				(-0.00717463813064+0.00333521743368j) ,
				(-0.102197081562-0.229242509091j) ,
				(0.373579749602-0.168777846725j) ,
				(0.0821456409525-0.228495944329j) ,
				(0.088393934543+0.129108150889j) ,
				(-0.306671423104-0.0602786873263j) ,
				(-0.124561301477-0.294696808988j) ,
				(0.0387818800449+0.103855196768j) ,
				(-0.39431290278+0.0981997643622j) ,
				(0.000448326512629-0.0237181294023j) 
				],
				[
				0j ,
				0j ,
				(-1.7906815843e-06+0j) ,
				0j ,
				(0.000247418129754+0j) ,
				8.95340792152e-07j ,
				(-6.21336946552e-06-8.21077264074e-05j) ,
				(8.21077264074e-05-0.000123709064878j) ,
				(-0.353428819872+0.00745187288839j) ,
				(-0.00761608834121+2.65901435208e-06j) ,
				(-7.97704300765e-06-0.161379555875j) ,
				(0.176447517105+0.176776264469j) ,
				(-0.176528846339-0.345287846932j) ,
				(0.00762498940486+2.65901434772e-06j) ,
				(-4.44969593202e-06-0.368144224763j) ,
				(-7.88255787453e-07-0.000123709064877j)
				],
				[
				0j ,
				0j ,
				(-2.2171211518e-06-9.183616505e-07j) ,
				(-4.42083073181e-05+0.000106728295097j) ,
				(1.01189146413e-05+2.35466837993e-06j) ,
				(0.00415476081971-0.00983713498548j) ,
				(0.00693222930968+0.00309426792486j) ,
				(-0.102615412367+0.229164834359j) ,
				(-0.123506405764-0.0656400237472j) ,
				(0.22877566758-0.124986079158j) ,
				(0.265755280293+0.482918355036j) ,
				(0.296809890569+0.163999210059j) ,
				(0.0208266504305+0.308786033288j) ,
				(-0.211309970412-0.207165416515j) ,
				(-0.459488252644-0.255590562204j) ,
				(0.103579800639-0.226357705637j)
				]]).flatten(order='F')	
		
		ref_fft = pl.asarray([
				[
				(-1.42284024508e-07-1.42284024508e-07j) ,
				(1.49578534761e-06+1.68841459656e-18j) ,
				(5.46909105767e-07+2.63701382484e-05j) ,
				(-0.000222584847004-3.62108106978e-06j) ,
				(0.000270427397275-0.00225279348536j) ,
				(0.0144374243424+0.000494901157701j) ,
				(-0.000500477574404+0.0644700519048j) ,
				(-0.365843228995-0.000509467374004j) ,
				(-0.7066071889-0.891922893614j) ,
				(0.587107865482-0.706378242026j) ,
				(0.707583375763-0.584846785498j) ,
				(0.595581586088+0.707349407687j) ,
				(-0.706841588297+0.338569118389j) ,
				(-0.362779869851-0.706612451898j) ,
				(-0.707609423439-0.440108201897j) ,
				(-1.22275924389-0.707615257728j) ,
				],
				[
				(-1.42284024508e-07-1.42284024508e-07j) ,
				(-1.48980892776e-18-2.04595674662e-06j) ,
				(3.07392433649e-06+2.22623155606e-07j) ,
				(3.76336509449e-06+0.000361978277427j) ,
				(-0.000447992985579+0.000267925314695j) ,
				(-0.000491542417676-0.0248703376194j) ,
				(0.0264754481602+3.27088766743e-05j) ,
				(-0.000257057566008+0.567272640861j) ,
				(-0.64938922244-0.707372466876j) ,
				(0.706847814191+0.192610985576j) ,
				(0.662928403414-0.707596168916j) ,
				(0.707384408049+0.270208306541j) ,
				(-1.26941191731+0.707377888006j) ,
				(0.706614203876-0.912682371072j) ,
				(-0.370850625142+0.707153396878j) ,
				(-0.707365946831-0.904018167312j) ,
				],
				[
				(-1.42284024508e-07-1.42284024508e-07j) ,
				(1.74655043126e-06+1.98245414327e-18j) ,
				(7.7493533441e-06+2.6070731933e-05j) ,
				(7.04355108104e-05+3.62108106959e-06j) ,
				(-0.000715546654827-0.00181525469759j) ,
				(-0.0142478690298-0.000494616589634j) ,
				(-0.000472161411268+0.0247778955483j) ,
				(0.335633243458+0.000500886543364j) ,
				(0.706623988005+0.0434709478218j) ,
				(0.694069983087+0.706831657546j) ,
				(0.707625325651-0.539866352064j) ,
				(0.213154575179-0.70682913012j) ,
				(0.706389226879-0.322717577539j) ,
				(0.989448441789+0.706598047232j) ,
				(-0.70758134511+0.734316591644j) ,
				(-1.01421443348-0.706608002722j) ,
				],
				[
				(-1.42284024508e-07-1.42284024508e-07j) ,
				(-1.89215540261e-18-2.21861613481e-06j) ,
				(2.77451802112e-06+2.62341056751e-07j) ,
				(-3.47879704511e-06+5.38962619047e-05j) ,
				(1.01866197735e-05+0.000271623781611j) ,
				(0.000483530723279+0.00373402091211j) ,
				(-0.0148817138548+2.53083187464e-05j) ,
				(0.000708080316672-0.0629437312678j) ,
				(0.320958009978-0.706383156081j) ,
				(-0.707386310855+1.28110933587j) ,
				(0.625188083673-0.70761744103j) ,
				(-0.706846419973+0.142210408437j) ,
				(0.744774171743-0.706831866018j) ,
				(0.707578544088+1.0723961047j) ,
				(-0.0122636532841+0.707132362595j) ,
				(-0.706384076312-1.31110775553j) ,
				],
				[
				(-1.42284024508e-07-1.42284024508e-07j) ,
				(2.21861613481e-06+1.70734048898e-18j) ,
				(5.46909105764e-07+2.4899499721e-06j) ,
				(-5.77191444462e-05+3.62108106973e-06j) ,
				(0.000263185235135+3.85422226603e-05j) ,
				(-0.00370252197113-0.000494616589651j) ,
				(0.000489040172899-0.0175374169685j) ,
				(0.0774371877779+0.000500926261781j) ,
				(-0.707603098211+0.413682031552j) ,
				(-1.6178237202+0.706835395731j) ,
				(-0.707594813164-0.931848713612j) ,
				(0.328403724349-0.706825629767j) ,
				(0.707375200929+0.294985043556j) ,
				(0.623587472905+0.706601185859j) ,
				(0.707610517258-0.367610268085j) ,
				(0.589517718606-0.706604864093j) ,
				],
				[
				(-1.42284024508e-07-1.42284024508e-07j) ,
				(-1.9059138631e-18-1.74655043126e-06j) ,
				(2.6355299982e-05+7.46478529507e-06j) ,
				(-3.47879704507e-06-7.45577996672e-05j) ,
				(-0.00182168689233-0.000714350270491j) ,
				(0.000490733167499+0.0146921115537j) ,
				(0.0247603619611+5.35847640019e-05j) ,
				(-0.000277933452566-0.359454944283j) ,
				(0.0756950994993+0.706837080193j) ,
				(-0.707361732877-0.0891507929301j) ,
				(-1.19852596086-0.706593017442j) ,
				(0.706381256577-0.412286155149j) ,
				(-0.307728305642+0.70637473653j) ,
				(0.707617355349+0.913406567006j) ,
				(-0.339415304946-0.707056150186j) ,
				(0.706843600236+0.27983530381j) ,
				],
				[
				(-1.42284024508e-07-1.42284024508e-07j) ,
				(2.04595674662e-06+1.41330094227e-18j) ,
				(5.07191204621e-07+2.78935628747e-06j) ,
				(-0.000365078329181-3.62108106964e-06j) ,
				(0.00025948676822-0.000399035617961j) ,
				(0.0249765044076+0.000494901157684j) ,
				(0.000481996124457+0.0224903397071j) ,
				(-0.563374969755-0.000502264929247j) ,
				(-0.706624159367-0.551516148414j) ,
				(-0.282744500622-0.707357013634j) ,
				(-0.707615490938-0.361810881164j) ,
				(-0.0253880822729+0.706384507634j) ,
				(-0.706845286766+1.63163305879j) ,
				(-0.0526938661237+0.707622074592j) ,
				(0.707589601655-0.0389938092087j) ,
				(0.350511707846+0.70661926876j) ,
				],
				[
				(-1.42284024508e-07-1.42284024508e-07j) ,
				(-1.50363197761e-18-1.49578534761e-06j) ,
				(2.66547062974e-05+2.62341056734e-07j) ,
				(3.76336509453e-06+0.000219185388934j) ,
				(-0.00227982744483+0.000271623781611j) ,
				(-0.000491502699793-0.0139185139714j) ,
				(0.0664387854683+3.2550480899e-05j) ,
				(-0.000260561542564+0.332082604577j) ,
				(-0.924462777495-0.707372673831j) ,
				(0.707833629847+0.203463487231j) ,
				(-0.484767459994-0.706614289557j) ,
				(0.707370369254+0.391073062266j) ,
				(-0.234972938546+0.707364047323j) ,
				(-0.70759964484-0.334725020917j) ,
				(0.744110268882-0.707063550744j) ,
				(-0.707379985623+0.656457385637j) ,
				]]).flatten(order='F')
		
		ref_betas = pl.asarray([
				[
				(-1.42284024508e-07-1.42284024508e-07j) ,
				(1.49578534761e-06+1.68841459656e-18j) ,
				(5.46909105767e-07+2.63701382484e-05j) ,
				(-0.000222584847004-3.62108106978e-06j) ,
				(0.000270427397275-0.00225279348536j) ,
				(0.0144374243424+0.000494901157701j) ,
				(-0.000500477574404+0.0644700519048j) ,
				(-0.365843228995-0.000509467374004j) ,
				(-0.7066071889-0.891922893614j) ,
				(0.587107865482-0.706378242026j) ,
				(0.707583375763-0.584846785498j) ,
				(0.595581586088+0.707349407687j) ,
				(-0.706841588297+0.338569118389j) ,
				(-0.362779869851-0.706612451898j) ,
				(-0.707609423439-0.440108201897j) ,
				(-1.22275924389-0.707615257728j) ,
				],
				[
				(-1.42284024508e-07-1.42284024508e-07j) ,
				(1.48980892776e-18+2.04595674662e-06j) ,
				(3.07392433649e-06+2.22623155606e-07j) ,
				(-3.76336509449e-06-0.000361978277427j) ,
				(-0.000447992985579+0.000267925314695j) ,
				(0.000491542417676+0.0248703376194j) ,
				(0.0264754481602+3.27088766743e-05j) ,
				(0.000257057566008-0.567272640861j) ,
				(-0.64938922244-0.707372466876j) ,
				(-0.706847814191-0.192610985576j) ,
				(0.662928403414-0.707596168916j) ,
				(-0.707384408049-0.270208306541j) ,
				(-1.26941191731+0.707377888006j) ,
				(-0.706614203876+0.912682371072j) ,
				(-0.370850625142+0.707153396878j) ,
				(0.707365946831+0.904018167312j) ,
				],
				[
				(-1.42284024508e-07-1.42284024508e-07j) ,
				(1.74655043126e-06+1.98245414327e-18j) ,
				(7.7493533441e-06+2.6070731933e-05j) ,
				(7.04355108104e-05+3.62108106959e-06j) ,
				(-0.000715546654827-0.00181525469759j) ,
				(-0.0142478690298-0.000494616589634j) ,
				(-0.000472161411268+0.0247778955483j) ,
				(0.335633243458+0.000500886543364j) ,
				(0.706623988005+0.0434709478218j) ,
				(0.694069983087+0.706831657546j) ,
				(0.707625325651-0.539866352064j) ,
				(0.213154575179-0.70682913012j) ,
				(0.706389226879-0.322717577539j) ,
				(0.989448441789+0.706598047232j) ,
				(-0.70758134511+0.734316591644j) ,
				(-1.01421443348-0.706608002722j) ,
				],
				[
				(-1.42284024508e-07-1.42284024508e-07j) ,
				(1.89215540261e-18+2.21861613481e-06j) ,
				(2.77451802112e-06+2.62341056751e-07j) ,
				(3.47879704511e-06-5.38962619047e-05j) ,
				(1.01866197735e-05+0.000271623781611j) ,
				(-0.000483530723279-0.00373402091211j) ,
				(-0.0148817138548+2.53083187464e-05j) ,
				(-0.000708080316672+0.0629437312678j) ,
				(0.320958009978-0.706383156081j) ,
				(0.707386310855-1.28110933587j) ,
				(0.625188083673-0.70761744103j) ,
				(0.706846419973-0.142210408437j) ,
				(0.744774171743-0.706831866018j) ,
				(-0.707578544088-1.0723961047j) ,
				(-0.0122636532841+0.707132362595j) ,
				(0.706384076312+1.31110775553j) ,
				],
				[
				(-1.42284024508e-07-1.42284024508e-07j) ,
				(2.21861613481e-06+1.70734048898e-18j) ,
				(5.46909105764e-07+2.4899499721e-06j) ,
				(-5.77191444462e-05+3.62108106973e-06j) ,
				(0.000263185235135+3.85422226603e-05j) ,
				(-0.00370252197113-0.000494616589651j) ,
				(0.000489040172899-0.0175374169685j) ,
				(0.0774371877779+0.000500926261781j) ,
				(-0.707603098211+0.413682031552j) ,
				(-1.6178237202+0.706835395731j) ,
				(-0.707594813164-0.931848713612j) ,
				(0.328403724349-0.706825629767j) ,
				(0.707375200929+0.294985043556j) ,
				(0.623587472905+0.706601185859j) ,
				(0.707610517258-0.367610268085j) ,
				(0.589517718606-0.706604864093j) ,
				],
				[
				(-1.42284024508e-07-1.42284024508e-07j) ,
				(1.9059138631e-18+1.74655043126e-06j) ,
				(2.6355299982e-05+7.46478529507e-06j) ,
				(3.47879704507e-06+7.45577996672e-05j) ,
				(-0.00182168689233-0.000714350270491j) ,
				(-0.000490733167499-0.0146921115537j) ,
				(0.0247603619611+5.35847640019e-05j) ,
				(0.000277933452566+0.359454944283j) ,
				(0.0756950994993+0.706837080193j) ,
				(0.707361732877+0.0891507929301j) ,
				(-1.19852596086-0.706593017442j) ,
				(-0.706381256577+0.412286155149j) ,
				(-0.307728305642+0.70637473653j) ,
				(-0.707617355349-0.913406567006j) ,
				(-0.339415304946-0.707056150186j) ,
				(-0.706843600236-0.27983530381j) ,
				],
				[
				(-1.42284024508e-07-1.42284024508e-07j) ,
				(2.04595674662e-06+1.41330094227e-18j) ,
				(5.07191204621e-07+2.78935628747e-06j) ,
				(-0.000365078329181-3.62108106964e-06j) ,
				(0.00025948676822-0.000399035617961j) ,
				(0.0249765044076+0.000494901157684j) ,
				(0.000481996124457+0.0224903397071j) ,
				(-0.563374969755-0.000502264929247j) ,
				(-0.706624159367-0.551516148414j) ,
				(-0.282744500622-0.707357013634j) ,
				(-0.707615490938-0.361810881164j) ,
				(-0.0253880822729+0.706384507634j) ,
				(-0.706845286766+1.63163305879j) ,
				(-0.0526938661237+0.707622074592j) ,
				(0.707589601655-0.0389938092087j) ,
				(0.350511707846+0.70661926876j) ,
				],
				[
				(-1.42284024508e-07-1.42284024508e-07j) ,
				(1.50363197761e-18+1.49578534761e-06j) ,
				(2.66547062974e-05+2.62341056734e-07j) ,
				(-3.76336509453e-06-0.000219185388934j) ,
				(-0.00227982744483+0.000271623781611j) ,
				(0.000491502699793+0.0139185139714j) ,
				(0.0664387854683+3.2550480899e-05j) ,
				(0.000260561542564-0.332082604577j) ,
				(-0.924462777495-0.707372673831j) ,
				(-0.707833629847-0.203463487231j) ,
				(-0.484767459994-0.706614289557j) ,
				(-0.707370369254-0.391073062266j) ,
				(-0.234972938546+0.707364047323j) ,
				(0.70759964484+0.334725020917j) ,
				(0.744110268882-0.707063550744j) ,
				(0.707379985623-0.656457385637j) ,
				]])
				
		for l in range(ref_betas.shape[0]):
			for k in range(ref_betas.shape[1]):
				ref_betas[l][k] *= 1j**(l+k)	
		
		ref_betas = ref_betas.flatten(order='F')			
		
		ref_qam = pl.asarray([
			[
			(-1.42284024508e-07+1.68841459656e-18j) ,
			(-5.46909105767e-07+3.62108106978e-06j) ,
			(0.000270427397275+0.000494901157701j) ,
			(0.000500477574404+0.000509467374004j) ,
			(-0.7066071889-0.706378242026j) ,
			(-0.707583375763-0.707349407687j) ,
			(-0.706841588297-0.706612451898j) ,
			(0.707609423439+0.707615257728j) ,
			],
			[
			(-1.42284024508e-07-1.48980892776e-18j) ,
			(-2.22623155606e-07-3.76336509449e-06j) ,
			(0.000267925314695-0.000491542417676j) ,
			(-3.27088766743e-05+0.000257057566008j) ,
			(-0.707372466876+0.706847814191j) ,
			(0.707596168916-0.707384408049j) ,
			(0.707377888006+0.706614203876j) ,
			(-0.707153396878+0.707365946831j) ,
			],
			[
			(1.42284024508e-07-1.98245414327e-18j) ,
			(7.7493533441e-06+3.62108106959e-06j) ,
			(0.000715546654827+0.000494616589634j) ,
			(-0.000472161411268+0.000500886543364j) ,
			(-0.706623988005-0.706831657546j) ,
			(0.707625325651-0.70682913012j) ,
			(-0.706389226879-0.706598047232j) ,
			(-0.70758134511-0.706608002722j) ,
			],
			[
			(1.42284024508e-07+1.89215540261e-18j) ,
			(2.62341056751e-07-3.47879704511e-06j) ,
			(-0.000271623781611-0.000483530723279j) ,
			(2.53083187464e-05+0.000708080316672j) ,
			(0.706383156081+0.707386310855j) ,
			(-0.70761744103-0.706846419973j) ,
			(0.706831866018-0.707578544088j) ,
			(0.707132362595-0.706384076312j) ,
			],
			[
			(-1.42284024508e-07+1.70734048898e-18j) ,
			(-5.46909105764e-07-3.62108106973e-06j) ,
			(0.000263185235135-0.000494616589651j) ,
			(-0.000489040172899-0.000500926261781j) ,
			(-0.707603098211+0.706835395731j) ,
			(0.707594813164+0.706825629767j) ,
			(0.707375200929+0.706601185859j) ,
			(-0.707610517258+0.706604864093j) ,
			],
			[
			(-1.42284024508e-07-1.9059138631e-18j) ,
			(-7.46478529507e-06+3.47879704507e-06j) ,
			(-0.000714350270491+0.000490733167499j) ,
			(-5.35847640019e-05+0.000277933452566j) ,
			(0.706837080193-0.707361732877j) ,
			(0.706593017442-0.706381256577j) ,
			(0.70637473653+0.707617355349j) ,
			(0.707056150186-0.706843600236j) ,
			],
			[
			(1.42284024508e-07-1.41330094227e-18j) ,
			(5.07191204621e-07-3.62108106964e-06j) ,
			(-0.00025948676822-0.000494901157684j) ,
			(0.000481996124457-0.000502264929247j) ,
			(0.706624159367+0.707357013634j) ,
			(-0.707615490938+0.706384507634j) ,
			(0.706845286766-0.707622074592j) ,
			(0.707589601655+0.70661926876j) ,
			],
			[
			(1.42284024508e-07+1.50363197761e-18j) ,
			(2.62341056734e-07+3.76336509453e-06j) ,
			(-0.000271623781611+0.000491502699793j) ,
			(3.2550480899e-05-0.000260561542564j) ,
			(0.707372673831-0.707833629847j) ,
			(-0.706614289557+0.707370369254j) ,
			(-0.707364047323+0.70759964484j) ,
			(-0.707063550744-0.707379985623j) ,
			]]).flatten(order='F')
			 			   
		# set up flowgraph
		self.src = blocks.vector_source_c(iq_data, vlen=1)
		self.input_comm = fbmc.input_commutator_cvc(L)
		self.snk_input_comm = blocks.vector_sink_c(vlen=L)
		self.ppfb = fbmc.polyphase_filterbank_vcvc(L)
		self.snk_ppfb = blocks.vector_sink_c(vlen=L)
		self.fft = fft.fft_vcc(L, False, (()), False, 1)
		self.snk_fft = blocks.vector_sink_c(vlen=L)
		self.apply_betas = fbmc.apply_betas_vcvc(L, inverse=1)
		self.snk_betas = blocks.vector_sink_c(vlen=L)
		self.comb_iq = fbmc.combine_iq_vcvc(L)
		self.snk_qam = blocks.vector_sink_c(vlen=L)
		self.p2s = fbmc.parallel_to_serial_vcc(L,L)
		self.s2b = fbmc.symbols_to_bits_cb()
		self.snk_symbols = blocks.vector_sink_b(vlen=1)
		
		self.tb.connect(self.src, self.input_comm, self.ppfb, self.fft)
		self.tb.connect(self.input_comm, self.snk_input_comm)
		self.tb.connect(self.ppfb, self.snk_ppfb)
		self.tb.connect(self.fft, self.snk_fft)
		self.tb.connect(self.fft, self.apply_betas, self.comb_iq)
		self.tb.connect(self.apply_betas, self.snk_betas)
		self.tb.connect(self.comb_iq, self.snk_qam)
		self.tb.connect(self.comb_iq, self.p2s, self.s2b, self.snk_symbols)
		
		self.tb.run ()
		
		# check data
		print "test commutated input samples - skipped"
		data_input_comm = self.snk_input_comm.data() 
		print "len ref:", len(ref_input_comm), "len data:", len(data_input_comm)
		# asserting does not make sense here as the data format is not the same as in the reference implementation
		
		print "test ppfb output"
		data_ppfb = self.snk_ppfb.data()
		self.assertComplexTuplesAlmostEqual(data_ppfb, ref_ppfb, 3) # check for the first 3 digits after the comma
		
		print "test fft output" # for the sake of completeness
		data_fft = self.snk_fft.data()
		self.assertComplexTuplesAlmostEqual(data_fft, ref_fft, 3)
		
		print "test removal of the betas - skipped"
		data_betas = self.snk_betas.data()
		#print "data:", data_betas[:10]
		#print "ref:", ref_betas[:10]		
		#self.assertComplexTuplesAlmostEqual(data_betas, ref_betas, 3) #FIXME does not work, probably due to my own stupidity
		
		print "test OQAM to QAM conversion"
		data_qam = self.snk_qam.data()
		self.assertComplexTuplesAlmostEqual(data_qam, ref_qam, 3)

		
		print "test demodulated symbols - skipped"
		data_symbols = self.snk_symbols.data() 
		#self.assertComplexTuplesAlmostEqual(data_symbols, ref_symbols)


if __name__ == '__main__':
	gr_unittest.run(qa_rx)

